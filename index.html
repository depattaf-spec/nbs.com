<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NBS Team Ice Breaker</title>
    
    <!-- Allow connections to Supabase and CDN resources -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline'; connect-src 'self' https://zxmljycgcxvpliqkfzbd.supabase.co https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; img-src 'self' data:; font-src 'self' data:;">
    
    <!-- Favicon for all platforms -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23111827;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%23374151;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='100' height='100' rx='15' fill='url(%23grad)' transform='rotate(3 50 50)'/%3E%3Ctext x='50' y='65' font-family='Arial, sans-serif' font-size='32' font-weight='900' fill='white' text-anchor='middle' transform='rotate(-3 50 65)'%3ENBS%3C/text%3E%3Ccircle cx='75' cy='75' r='12' fill='%232563eb'/%3E%3C/svg%3E">
    
    <meta name="theme-color" content="#111827">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 50%, #e7e5e4 100%);
            min-height: 100vh;
        }
        
        .container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
            border: 1px solid #e5e7eb;
            padding: 40px;
            max-width: 500px;
            width: 100%;
        }
        
        .card-wide {
            max-width: 800px;
        }
        
        .logo-container {
            text-align: center;
            margin-bottom: 32px;
        }
        
        .logo {
            position: relative;
            display: inline-block;
            margin-bottom: 16px;
        }
        
        .logo-box {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #111827 0%, #374151 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transform: rotate(3deg);
        }
        
        .logo-text {
            color: white;
            font-size: 24px;
            font-weight: 900;
            transform: rotate(-3deg);
        }
        
        .logo-dot {
            position: absolute;
            bottom: -4px;
            right: -4px;
            width: 24px;
            height: 24px;
            background: #2563eb;
            border-radius: 50%;
        }
        
        h1 {
            font-size: 36px;
            font-weight: 900;
            color: #111827;
            text-align: center;
            margin-bottom: 8px;
        }
        
        .subtitle {
            color: #6b7280;
            text-align: center;
            font-weight: 500;
        }
        
        .progress-box {
            background: #eff6ff;
            border: 1px solid #dbeafe;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
        }
        
        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .progress-label {
            font-size: 12px;
            font-weight: 700;
            color: #1e3a8a;
            text-transform: uppercase;
        }
        
        .progress-count {
            font-size: 12px;
            font-weight: 700;
            color: #2563eb;
        }
        
        .progress-bar-bg {
            width: 100%;
            height: 8px;
            background: #bfdbfe;
            border-radius: 999px;
            overflow: hidden;
        }
        
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #2563eb 0%, #3b82f6 100%);
            border-radius: 999px;
            transition: width 0.5s ease;
        }
        
        .progress-text {
            font-size: 11px;
            color: #1e40af;
            margin-top: 8px;
        }
        
        label {
            display: block;
            color: #374151;
            font-weight: 600;
            margin-bottom: 12px;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        select {
            width: 100%;
            padding: 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 16px;
            background: #f9fafb;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        select:hover {
            border-color: #d1d5db;
        }
        
        select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .voted-notice {
            margin-top: 8px;
            font-size: 14px;
            color: #16a34a;
            font-weight: 500;
        }
        
        button {
            width: 100%;
            padding: 16px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 16px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #111827;
            color: white;
            box-shadow: 0 4px 14px rgba(0,0,0,0.2);
        }
        
        .btn-primary:hover:not(:disabled) {
            background: #1f2937;
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            transform: translateY(-2px);
        }
        
        .btn-primary:disabled {
            background: #e5e7eb;
            color: #9ca3af;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }
        
        .btn-secondary {
            background: white;
            color: #111827;
            border: 2px solid #111827;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-top: 16px;
        }
        
        .btn-secondary:hover {
            background: #111827;
            color: white;
            box-shadow: 0 4px 14px rgba(0,0,0,0.2);
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background: #dc2626;
            color: white;
            box-shadow: 0 4px 14px rgba(220, 38, 38, 0.3);
            margin-left: 16px;
            width: auto;
            display: inline-block;
        }
        
        .btn-danger:hover {
            background: #b91c1c;
            box-shadow: 0 6px 20px rgba(220, 38, 38, 0.4);
            transform: translateY(-2px);
        }
        
        .footer {
            margin-top: 32px;
            padding-top: 32px;
            border-top: 1px solid #e5e7eb;
            text-align: center;
        }
        
        .footer-text {
            font-size: 11px;
            color: #9ca3af;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }
        
        .quiz-header {
            margin-bottom: 32px;
        }
        
        .quiz-progress {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .quiz-label {
            font-size: 12px;
            font-weight: 700;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .quiz-player {
            font-size: 12px;
            font-weight: 700;
            color: #111827;
            background: #f3f4f6;
            padding: 4px 12px;
            border-radius: 999px;
        }
        
        .question-card {
            border-radius: 12px;
            padding: 32px;
            margin-bottom: 32px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .question-text {
            font-size: 24px;
            font-weight: 700;
            color: white;
            line-height: 1.5;
        }
        
        .options-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }
        
        .option-btn {
            padding: 20px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: none;
            letter-spacing: normal;
        }
        
        .option-btn:hover {
            background: #f9fafb;
            border-color: #111827;
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }
        
        .results-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 48px 20px;
        }
        
        .results-header {
            text-align: center;
            margin-bottom: 48px;
        }
        
        .trophy-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #111827 0%, #374151 100%);
            border-radius: 12px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            transform: rotate(3deg);
            margin-bottom: 24px;
            font-size: 40px;
        }
        
        .results-title {
            font-size: 48px;
            font-weight: 900;
            color: #111827;
            margin-bottom: 16px;
        }
        
        .results-subtitle {
            font-size: 20px;
            color: #6b7280;
            font-weight: 500;
            margin-bottom: 16px;
        }
        
        .vote-count-box {
            display: inline-block;
            background: #eff6ff;
            border: 1px solid #dbeafe;
            padding: 12px 24px;
            border-radius: 12px;
        }
        
        .vote-count-text {
            font-size: 14px;
            font-weight: 700;
            color: #1e3a8a;
        }
        
        .results-list {
            margin-bottom: 48px;
        }
        
        .result-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            border: 1px solid #e5e7eb;
            margin-bottom: 16px;
            transition: all 0.3s;
        }
        
        .result-card:hover {
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
            transform: translateY(-4px);
        }
        
        .result-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }
        
        .result-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .rank-badge {
            width: 56px;
            height: 56px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            flex-shrink: 0;
        }
        
        .rank-number {
            font-size: 20px;
            font-weight: 900;
            color: white;
        }
        
        .result-info h3 {
            font-size: 24px;
            font-weight: 900;
            color: #111827;
            margin-bottom: 4px;
        }
        
        .result-info p {
            font-size: 18px;
            color: #6b7280;
            font-weight: 500;
        }
        
        .action-buttons {
            text-align: center;
        }
        
        .action-buttons .btn-primary,
        .action-buttons .btn-secondary {
            width: auto;
            display: inline-block;
            padding: 16px 40px;
            margin: 8px;
        }
        
        .action-buttons .btn-danger {
            margin-top: 8px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
        }
        
        .spinner {
            width: 64px;
            height: 64px;
            border: 4px solid #e5e7eb;
            border-top-color: #111827;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @media (max-width: 640px) {
            h1 {
                font-size: 28px;
            }
            
            .results-title {
                font-size: 32px;
            }
            
            .results-subtitle {
                font-size: 16px;
            }
            
            .options-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }
            
            .option-btn {
                padding: 16px 12px;
                font-size: 14px;
            }
            
            .result-content {
                flex-direction: column;
                text-align: center;
            }
            
            .result-left {
                flex-direction: column;
                align-items: center;
            }
            
            .result-info {
                text-align: center;
            }
            
            .result-info h3 {
                font-size: 20px;
            }
            
            .result-info p {
                font-size: 16px;
            }
            
            .podium-wrapper {
                display: flex !important;
                flex-direction: row !important;
                align-items: flex-end !important;
                gap: 8px !important;
                justify-content: center !important;
            }
            
            .podium-winner {
                transform: scale(1.1) !important;
            }
            
            .action-buttons {
                display: flex;
                flex-direction: column;
                gap: 12px;
                width: 100%;
                padding: 0 16px;
            }
            
            .action-buttons .btn-primary,
            .action-buttons .btn-secondary,
            .action-buttons .btn-danger {
                width: 100% !important;
                margin: 0 !important;
                display: block !important;
            }
            
            .results-container {
                padding: 24px 16px;
            }
            
            .result-card {
                padding: 20px 16px;
            }
            
            .rank-badge {
                width: 48px;
                height: 48px;
            }
            
            .rank-number {
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@1.35.7/dist/umd/supabase.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script>
        const SUPABASE_URL = 'https://zxmljycgcxvpliqkfzbd.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp4bWxqeWNnY3h2cGxpcWtmemJkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4NjMzOTMsImV4cCI6MjA3ODQzOTM5M30.d84DHtVKYeNq1yFNQ86mG4t5jbRuB9hR27Md4uqFZe8';
        
        let supabase;
        
        const teamMembers = ['Andreas', 'Raquel', 'Sara', 'Ines', 'Nicole', 'Federico'];
        
        const questions = [
            { id: 1, question: "Who is most likely to accidentally start a fire while cooking?", award: "üî• Fire While Cooking", gradient: "linear-gradient(135deg, #f43f5e 0%, #fb923c 100%)", category: "fun" },
            { id: 2, question: "Who would be elected president if your team started a country?", award: "üëë Team President", gradient: "linear-gradient(135deg, #2563eb 0%, #06b6d4 100%)", category: "personality" },
            { id: 3, question: "Who would survive the longest in a zombie apocalypse?", award: "üßü Zombie Survivor", gradient: "linear-gradient(135deg, #059669 0%, #14b8a6 100%)", category: "skills" },
            { id: 4, question: "Who would be brave enough to do karaoke without any drinks first?", award: "üé§ Karaoke Without Drinks", gradient: "linear-gradient(135deg, #7c3aed 0%, #a855f7 100%)", category: "personality" },
            { id: 5, question: "Who would miss their own birthday party?", award: "ü§¶ Miss Own Birthday", gradient: "linear-gradient(135deg, #f59e0b 0%, #fb923c 100%)", category: "fun" },
            { id: 6, question: "Who can't function without coffee in the morning?", award: "‚òï Can't Function Without Coffee", gradient: "linear-gradient(135deg, #b45309 0%, #ca8a04 100%)", category: "personality" },
            { id: 7, question: "Who would post something meant to be private on the public chat?", award: "üí¨ Post Private on Public", gradient: "linear-gradient(135deg, #db2777 0%, #f43f5e 100%)", category: "fun" },
            { id: 8, question: "Who is the most creative person on the team?", award: "üé® Most Creative", gradient: "linear-gradient(135deg, #4f46e5 0%, #3b82f6 100%)", category: "skills" },
            { id: 9, question: "Who would eat pineapple on pizza without complaining?", award: "üçï Pineapple on Pizza", gradient: "linear-gradient(135deg, #dc2626 0%, #fb923c 100%)", category: "fun" },
            { id: 10, question: "Who knows all the best spots in town for food and fun?", award: "üó∫Ô∏è Best Spots in Town", gradient: "linear-gradient(135deg, #c026d3 0%, #ec4899 100%)", category: "personality" },
            { id: 11, question: "Who would win in a dance-off competition?", award: "üíÉ Dance-Off Winner", gradient: "linear-gradient(135deg, #ec4899 0%, #f43f5e 100%)", category: "skills" },
            { id: 12, question: "Who always has the best memes and funny videos?", award: "üòé Best Memes", gradient: "linear-gradient(135deg, #8b5cf6 0%, #d946ef 100%)", category: "fun" },
            { id: 13, question: "Who would be the first to fall asleep during a movie night?", award: "üò¥ First to Fall Asleep", gradient: "linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%)", category: "fun" },
            { id: 14, question: "Who would you call at 3 AM if you needed to talk?", award: "üíô 3 AM Call", gradient: "linear-gradient(135deg, #0891b2 0%, #06b6d4 100%)", category: "personality" },
            { id: 15, question: "Who is most likely to forget their phone exists for an entire day?", award: "üìµ Forget Phone Exists", gradient: "linear-gradient(135deg, #10b981 0%, #34d399 100%)", category: "skills" }
        ];

        let currentScreen = 'welcome';
        let playerName = '';
        let currentQuestion = 0;
        let votes = {};
        let hasVoted = {};
        let votingStartTimes = {};
        let individualVotes = {};
        let loading = true;
        
        const profilePics = {
            'Andreas': 'üë®‚Äçüíº',
            'Raquel': 'üë©‚Äçüíº', 
            'Sara': 'üë©‚Äçü¶∞',
            'Ines': 'üë©‚Äçü¶±',
            'Nicole': 'üë©',
            'Federico': 'üë®'
        };

        // Initialize Supabase
        async function initSupabase() {
            try {
                const supabaseConfig = {
                    schema: 'public',
                    autoRefreshToken: true,
                    persistSession: false,
                    detectSessionInUrl: false
                };
                
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, supabaseConfig);
                console.log('‚úÖ Supabase initialized');
                return true;
            } catch (err) {
                console.error('‚ùå Supabase init error:', err);
                return false;
            }
        }

        // FIXED: Load and merge all votes properly
        async function loadData() {
            try {
                if (!supabase) {
                    await initSupabase();
                }

                console.log('üì• Loading all votes from database...');
                
                // Get ALL rows, not just the last one
                // Try without order first to see if that's causing issues
                const { data, error } = await supabase
                    .from('team_votes')
                    .select('*');

                if (error) {
                    console.error('‚ùå Load error:', error);
                    console.error('Error details:', JSON.stringify(error, null, 2));
                    // Initialize with empty data so app still works
                    votes = {};
                    hasVoted = {};
                    individualVotes = {};
                    votingStartTimes = {};
                } else if (data && data.length > 0) {
                    // Sort data by created_at in JavaScript instead
                    data.sort((a, b) => {
                        const dateA = new Date(a.created_at || 0);
                        const dateB = new Date(b.created_at || 0);
                        return dateA - dateB;
                    });
                    console.log(`‚úÖ Found ${data.length} vote records in database`);
                    
                    // Initialize empty objects
                    votes = {};
                    hasVoted = {};
                    individualVotes = {};
                    votingStartTimes = {};
                    
                    // Merge all records - later records override earlier ones
                    data.forEach((record, index) => {
                        console.log(`Merging record ${index + 1}:`, {
                            voters: Object.keys(record.has_voted || {}).filter(k => k.indexOf('_endTime') === -1)
                        });
                        
                        // Merge votes
                        if (record.votes) {
                            Object.keys(record.votes).forEach(questionId => {
                                if (!votes[questionId]) votes[questionId] = {};
                                Object.assign(votes[questionId], record.votes[questionId]);
                            });
                        }
                        
                        // Merge hasVoted
                        if (record.has_voted) {
                            Object.assign(hasVoted, record.has_voted);
                        }
                        
                        // Merge individual votes
                        if (record.individual_votes) {
                            Object.assign(individualVotes, record.individual_votes);
                        }
                        
                        // Merge voting start times
                        if (record.voting_start_times) {
                            Object.assign(votingStartTimes, record.voting_start_times);
                        }
                    });
                    
                    const votersList = Object.keys(hasVoted).filter(k => k.indexOf('_endTime') === -1);
                    console.log(`‚úÖ Total unique voters after merge: ${votersList.length}`, votersList);
                } else {
                    console.log('‚ÑπÔ∏è No existing data, starting fresh');
                    votes = {};
                    hasVoted = {};
                    individualVotes = {};
                    votingStartTimes = {};
                }
            } catch (err) {
                console.error('‚ùå Load exception:', err);
                votes = {};
                hasVoted = {};
                individualVotes = {};
                votingStartTimes = {};
            } finally {
                loading = false;
                render();
            }
        }

        // FIXED: Save as NEW row to avoid race conditions (works without created_at)
        async function saveData() {
            try {
                console.log('üíæ Saving vote data as new record...');
                
                const payload = {
                    votes: votes,
                    has_voted: hasVoted,
                    individual_votes: individualVotes,
                    voting_start_times: votingStartTimes,
                    updated_at: new Date().toISOString()
                };

                const votersList = Object.keys(hasVoted).filter(k => k.indexOf('_endTime') === -1);
                console.log('Saving votes for:', votersList);

                // Always INSERT a new row instead of updating
                const { data: inserted, error: insertError } = await supabase
                    .from('team_votes')
                    .insert([payload])
                    .select();
                
                if (insertError) {
                    console.error('‚ùå Insert error:', insertError);
                    console.error('Error details:', JSON.stringify(insertError, null, 2));
                    console.error('Error hint:', insertError.hint || 'No hint available');
                    console.error('Error code:', insertError.code || 'No code');
                    
                    // Show user-friendly error
                    if (insertError.message && (insertError.message.includes('CORS') || insertError.message.includes('Network'))) {
                        alert('‚ö†Ô∏è Network error. Your vote was saved locally but may not sync with others. Please check your internet connection.');
                    } else {
                        alert('‚ö†Ô∏è Failed to save votes: ' + (insertError.message || 'Unknown error') + '. Your vote may not be visible to others.');
                    }
                } else {
                    console.log('‚úÖ Vote saved successfully as new record!');
                    console.log('Saved record:', inserted);
                    
                    // Clean up old records - keep only last 100
                    setTimeout(async () => {
                        try {
                            const { data: allRecords } = await supabase
                                .from('team_votes')
                                .select('id, updated_at')
                                .order('id', { ascending: false })
                                .limit(200);
                            
                            if (allRecords && allRecords.length > 100) {
                                const idsToDelete = allRecords.slice(100).map(r => r.id);
                                await supabase
                                    .from('team_votes')
                                    .delete()
                                    .in('id', idsToDelete);
                                console.log(`üßπ Cleaned up ${idsToDelete.length} old records`);
                            }
                        } catch (cleanupErr) {
                            console.log('‚ö†Ô∏è Cleanup failed (non-critical):', cleanupErr.message);
                        }
                    }, 2000);
                }
            } catch (err) {
                console.error('‚ùå Save error:', err);
                console.error('Exception details:', err.message, err.stack);
                alert('‚ö†Ô∏è Failed to save votes. Your vote is saved locally but may not be visible to others. Error: ' + err.message);
            }
        }

        function playSound(type) {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                if (type === 'trumpet') {
                    const notes = [
                        { freq: 523.25, time: 0, duration: 0.15 },
                        { freq: 659.25, time: 0.15, duration: 0.15 },
                        { freq: 783.99, time: 0.3, duration: 0.15 },
                        { freq: 1046.50, time: 0.5, duration: 0.4 }
                    ];
                    
                    notes.forEach(note => {
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();
                        
                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);
                        
                        oscillator.type = 'sawtooth';
                        oscillator.frequency.value = note.freq;
                        
                        gainNode.gain.setValueAtTime(0, audioContext.currentTime + note.time);
                        gainNode.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + note.time + 0.05);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + note.time + note.duration);
                        
                        oscillator.start(audioContext.currentTime + note.time);
                        oscillator.stop(audioContext.currentTime + note.time + note.duration);
                    });
                }
            } catch (e) {}
        }

        function launchConfetti() {
            if (typeof confetti !== 'undefined') {
                confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.6 }
                });
            }
        }

        function launchCelebrationConfetti() {
            if (typeof confetti !== 'undefined') {
                const duration = 750;
                const end = Date.now() + duration;

                (function frame() {
                    confetti({
                        particleCount: 3,
                        angle: 60,
                        spread: 55,
                        origin: { x: 0 }
                    });
                    confetti({
                        particleCount: 3,
                        angle: 120,
                        spread: 55,
                        origin: { x: 1 }
                    });

                    if (Date.now() < end) {
                        requestAnimationFrame(frame);
                    }
                })();
            }
        }

        function calculateBadges() {
            const newBadges = {};
            const voteTimes = Object.keys(hasVoted).map(name => ({
                name,
                time: votingStartTimes[name] || Date.now()
            })).sort((a, b) => a.time - b.time);
            
            if (voteTimes.length > 0) {
                newBadges[voteTimes[0].name] = newBadges[voteTimes[0].name] || [];
                newBadges[voteTimes[0].name].push('üê¶ Early Bird');
            }
            
            Object.entries(votingStartTimes).forEach(([name, time]) => {
                const endTime = hasVoted[name + '_endTime'] || time;
                const duration = (endTime - time) / 1000;
                if (duration < 30) {
                    newBadges[name] = newBadges[name] || [];
                    newBadges[name].push('‚ö° Speed Demon');
                }
            });
            
            Object.keys(hasVoted).forEach(name => {
                if (name.indexOf('_endTime') === -1) {
                    newBadges[name] = newBadges[name] || [];
                    newBadges[name].push('‚úÖ Completionist');
                }
            });
            
            return newBadges;
        }

        function calculateStatistics() {
            const stats = {
                totalVotes: 0,
                mostUnanimous: null,
                mostUnanimousWinner: null,
                closestRace: null,
                closestRaceTop2: [],
                votingOrder: [],
                mostSelfVotes: null,
                mostSelfVotesCount: 0
            };
            
            Object.values(votes).forEach(questionVotes => {
                Object.values(questionVotes).forEach(count => {
                    stats.totalVotes += count;
                });
            });
            
            const selfVoteCounts = {};
            Object.entries(individualVotes).forEach(([voter, votedFor]) => {
                let selfVoteCount = 0;
                Object.entries(votedFor).forEach(([questionId, recipient]) => {
                    if (voter === recipient) {
                        selfVoteCount++;
                    }
                });
                if (selfVoteCount > 0) {
                    selfVoteCounts[voter] = selfVoteCount;
                }
            });
            
            let maxSelfVotes = 0;
            Object.entries(selfVoteCounts).forEach(([person, count]) => {
                if (count > maxSelfVotes) {
                    maxSelfVotes = count;
                    stats.mostSelfVotes = person;
                    stats.mostSelfVotesCount = count;
                }
            });
            
            let maxDiff = 0;
            questions.forEach(q => {
                const questionVotes = votes[q.id] || {};
                const sortedVoters = Object.entries(questionVotes).sort(([, a], [, b]) => b - a);
                if (sortedVoters.length >= 2) {
                    const diff = sortedVoters[0][1] - sortedVoters[1][1];
                    if (diff > maxDiff) {
                        maxDiff = diff;
                        stats.mostUnanimous = q;
                        stats.mostUnanimousWinner = sortedVoters[0][0];
                    }
                }
            });
            
            let minDiff = Infinity;
            questions.forEach(q => {
                const questionVotes = votes[q.id] || {};
                const sortedVoters = Object.entries(questionVotes).sort(([, a], [, b]) => b - a);
                if (sortedVoters.length >= 2) {
                    const diff = sortedVoters[0][1] - sortedVoters[1][1];
                    if (diff > 0 && diff < minDiff) {
                        minDiff = diff;
                        stats.closestRace = q;
                        stats.closestRaceTop2 = [sortedVoters[0][0], sortedVoters[1][0]];
                    }
                }
            });
            
            const voteTimes = Object.entries(votingStartTimes)
                .map(([name, time]) => ({ name, time }))
                .sort((a, b) => a.time - b.time);
            stats.votingOrder = voteTimes.map(v => v.name);
            
            return stats;
        }

        function handleVote(member) {
            if (currentQuestion === 0 && !votingStartTimes[playerName]) {
                votingStartTimes[playerName] = Date.now();
            }
            
            const questionId = questions[currentQuestion].id;
            
            if (!individualVotes[playerName]) individualVotes[playerName] = {};
            individualVotes[playerName][questionId] = member;
            
            if (!votes[questionId]) votes[questionId] = {};
            if (!votes[questionId][member]) votes[questionId][member] = 0;
            votes[questionId][member]++;

            if (currentQuestion < questions.length - 1) {
                currentQuestion++;
                render();
            } else {
                hasVoted[playerName + '_endTime'] = Date.now();
                hasVoted[playerName] = true;
                
                saveData().then(() => {
                    currentScreen = 'waiting';
                    render();
                });
            }
        }

        function promptResetPassword() {
            const password = prompt('Enter password to reset ALL votes from database:');
            if (password === 'reset123') {
                // Clear local data
                votes = {};
                hasVoted = {};
                votingStartTimes = {};
                individualVotes = {};
                
                // Delete ALL rows from database
                deleteAllVotesFromDatabase().then(() => {
                    alert('‚úÖ All votes have been deleted from the database!');
                    currentScreen = 'welcome';
                    playerName = '';
                    currentQuestion = 0;
                    render();
                });
            } else if (password !== null) {
                alert('‚ùå Incorrect password. Access denied.');
            }
        }

        async function deleteAllVotesFromDatabase() {
            try {
                console.log('üóëÔ∏è Deleting ALL votes from database...');
                
                // Get all record IDs
                const { data: allRecords, error: selectError } = await supabase
                    .from('team_votes')
                    .select('id');
                
                if (selectError) {
                    console.error('‚ùå Error fetching records:', selectError);
                    alert('‚ö†Ô∏è Failed to fetch records: ' + selectError.message);
                    return;
                }
                
                if (!allRecords || allRecords.length === 0) {
                    console.log('‚ÑπÔ∏è No records to delete');
                    return;
                }
                
                console.log(`Found ${allRecords.length} records to delete`);
                
                // Delete all records
                const { error: deleteError } = await supabase
                    .from('team_votes')
                    .delete()
                    .in('id', allRecords.map(r => r.id));
                
                if (deleteError) {
                    console.error('‚ùå Delete error:', deleteError);
                    alert('‚ö†Ô∏è Failed to delete votes: ' + deleteError.message);
                } else {
                    console.log('‚úÖ Successfully deleted all votes from database!');
                }
            } catch (err) {
                console.error('‚ùå Delete exception:', err);
                alert('‚ö†Ô∏è Failed to delete votes: ' + err.message);
            }
        }

        function StatisticsScreen() {
            const stats = calculateStatistics();
            const allBadges = calculateBadges();
            const results = calculateResults();
            
            return `
                <div class="results-container">
                    <div class="results-header">
                        <div class="trophy-icon">üìä</div>
                        <h1 class="results-title">Fun Statistics</h1>
                        <p class="results-subtitle">Interesting insights from the votes</p>
                    </div>
                    
                    <div class="results-list">
                        <div class="result-card">
                            <h3 style="margin-bottom: 16px; color: #111827;">üìà Overall Stats</h3>
                            <p style="color: #6b7280; margin-bottom: 8px;">Total votes cast: <strong>${stats.totalVotes}</strong></p>
                            <p style="color: #6b7280; margin-bottom: 8px;">Team members voted: <strong>${Object.keys(hasVoted).filter(k => k.indexOf('_endTime') === -1).length}</strong></p>
                            <p style="color: #6b7280;">Questions answered: <strong>${questions.length}</strong></p>
                        </div>
                        
                        ${stats.mostUnanimous ? `
                        <div class="result-card">
                            <h3 style="margin-bottom: 16px; color: #111827;">üéØ Most Unanimous Decision</h3>
                            <p style="color: #6b7280; margin-bottom: 8px;">"${stats.mostUnanimous.question}"</p>
                            <p style="color: #10b981; font-weight: 600; margin-bottom: 4px;">${stats.mostUnanimous.award}</p>
                            <p style="color: #111827; font-weight: 700; font-size: 18px;">${profilePics[stats.mostUnanimousWinner]} ${stats.mostUnanimousWinner}</p>
                            <p style="color: #6b7280; font-size: 14px; margin-top: 4px;">Everyone agreed on this one!</p>
                        </div>
                        ` : ''}
                        
                        ${stats.closestRace ? `
                        <div class="result-card">
                            <h3 style="margin-bottom: 16px; color: #111827;">‚öîÔ∏è Closest Race</h3>
                            <p style="color: #6b7280; margin-bottom: 8px;">"${stats.closestRace.question}"</p>
                            <p style="color: #f59e0b; font-weight: 600; margin-bottom: 8px;">${stats.closestRace.award}</p>
                            <p style="color: #111827; font-weight: 700;">
                                ${profilePics[stats.closestRaceTop2[0]]} ${stats.closestRaceTop2[0]} 
                                <span style="color: #6b7280; font-weight: 400;">vs</span> 
                                ${profilePics[stats.closestRaceTop2[1]]} ${stats.closestRaceTop2[1]}
                            </p>
                            <p style="color: #6b7280; font-size: 14px; margin-top: 4px;">It was neck and neck!</p>
                        </div>
                        ` : ''}
                        
                        ${stats.votingOrder.length > 0 ? `
                        <div class="result-card">
                            <h3 style="margin-bottom: 16px; color: #111827;">‚è±Ô∏è Voting Order</h3>
                            <p style="color: #6b7280; margin-bottom: 12px;">Who completed the quiz first to last:</p>
                            ${stats.votingOrder.map((name, index) => `
                                <p style="color: #111827; margin-bottom: 8px; font-weight: ${index === 0 ? '700' : '500'};">
                                    ${index + 1}. ${profilePics[name]} ${name}
                                    ${index === 0 ? '<span style="color: #10b981; margin-left: 8px;">üê¶ First!</span>' : ''}
                                </p>
                            `).join('')}
                        </div>
                        ` : ''}
                        
                        ${stats.mostSelfVotes ? `
                        <div class="result-card">
                            <h3 style="margin-bottom: 16px; color: #111827;">ü™û Most Self-Confident</h3>
                            <p style="color: #6b7280; margin-bottom: 8px;">Who voted for themselves the most:</p>
                            <p style="color: #111827; font-weight: 700; font-size: 18px; margin-top: 8px;">${profilePics[stats.mostSelfVotes]} ${stats.mostSelfVotes}</p>
                            <p style="color: #6b7280; font-size: 14px; margin-top: 4px;">Voted for themselves ${stats.mostSelfVotesCount} out of ${questions.length} times!</p>
                        </div>
                        ` : ''}
                        
                        <div class="result-card">
                            <h3 style="margin-bottom: 16px; color: #111827;">üé≠ Award Distribution</h3>
                            ${Object.entries(results).map(([person, data]) => `
                                <p style="color: #6b7280; margin-bottom: 8px;">
                                    <strong>${profilePics[person]} ${person}:</strong> ${data.awards.length} award${data.awards.length !== 1 ? 's' : ''}
                                </p>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button onclick="backToResults()" class="btn-primary">Back to Results</button>
                        <button onclick="voteAgain()" class="btn-secondary">Vote Again</button>
                        
                        <div class="footer">
                            <p class="footer-text">Powered by No Boring Shops</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function calculateResults() {
            const personAwards = {};
            const awardsGiven = new Set();

            const questionsByVotes = questions.map(q => ({
                ...q,
                totalVotes: Object.values(votes[q.id] || {}).reduce((sum, v) => sum + v, 0)
            })).sort((a, b) => b.totalVotes - a.totalVotes);

            questionsByVotes.forEach((question) => {
                const questionVotes = votes[question.id] || {};
                const sortedVoters = Object.entries(questionVotes)
                    .sort(([, a], [, b]) => b - a)
                    .filter(([person]) => !personAwards[person]);
                
                if (sortedVoters.length > 0 && Object.keys(personAwards).length < teamMembers.length) {
                    const [winner, voteCount] = sortedVoters[0];
                    personAwards[winner] = {
                        awards: [{
                            award: question.award,
                            votes: voteCount,
                            questionId: question.id,
                            gradient: question.gradient
                        }],
                        totalVotes: voteCount
                    };
                    awardsGiven.add(question.id);
                }
            });

            const peopleWithoutAwards = teamMembers.filter(person => !personAwards[person]);
            const unusedAwards = questions.filter(q => !awardsGiven.has(q.id));
            
            peopleWithoutAwards.forEach((person, index) => {
                if (index < unusedAwards.length) {
                    const award = unusedAwards[index];
                    const voteCount = votes[award.id]?.[person] || 0;
                    personAwards[person] = {
                        awards: [{
                            award: award.award,
                            votes: voteCount,
                            questionId: award.id,
                            gradient: award.gradient
                        }],
                        totalVotes: voteCount
                    };
                    awardsGiven.add(award.id);
                }
            });

            const remainingAwards = questions.filter(q => !awardsGiven.has(q.id));
            
            remainingAwards.forEach((question) => {
                const questionVotes = votes[question.id] || {};
                if (Object.keys(questionVotes).length === 0) return;
                
                const sortedVoters = Object.entries(questionVotes)
                    .sort(([, a], [, b]) => b - a);
                
                if (sortedVoters.length > 0) {
                    const [winner, voteCount] = sortedVoters[0];
                    
                    if (personAwards[winner]) {
                        personAwards[winner].awards.push({
                            award: question.award,
                            votes: voteCount,
                            questionId: question.id,
                            gradient: question.gradient
                        });
                        personAwards[winner].totalVotes += voteCount;
                    }
                }
            });

            return personAwards;
        }

        function WelcomeScreen() {
            const votedCount = Object.keys(hasVoted).filter(k => k.indexOf('_endTime') === -1).length;
            const totalMembers = teamMembers.length;
            
            return `
                <div class="container">
                    <div class="card">
                        <div class="logo-container">
                            <div class="logo">
                                <div class="logo-box">
                                    <span class="logo-text">NBS</span>
                                </div>
                                <div class="logo-dot"></div>
                            </div>
                            <h1>Team Ice Breaker</h1>
                            <p class="subtitle">Discover what makes your team unique</p>
                        </div>

                        <div class="progress-box">
                            <div class="progress-header">
                                <span class="progress-label">Team Progress</span>
                                <span class="progress-count">${votedCount}/${totalMembers}</span>
                            </div>
                            <div class="progress-bar-bg">
                                <div class="progress-bar-fill" style="width: ${(votedCount / totalMembers) * 100}%"></div>
                            </div>
                            <p class="progress-text">
                                ${votedCount === totalMembers ? 'üéâ Everyone has voted!' : `${totalMembers - votedCount} team member${totalMembers - votedCount !== 1 ? 's' : ''} left to vote`}
                            </p>
                        </div>
                        
                        <div style="margin-bottom: 32px;">
                            <label>Select Your Name</label>
                            <select id="playerSelect">
                                <option value="">Choose your name...</option>
                                ${teamMembers.map(member => `<option value="${member}">${member} ${hasVoted[member] ? '‚úì' : ''}</option>`).join('')}
                            </select>
                            ${playerName && hasVoted[playerName] ? '<p class="voted-notice">‚úì You\'ve already voted! You can vote again to update your answers.</p>' : ''}
                        </div>
                        
                        <button id="startBtn" class="btn-primary" disabled>Start Quiz</button>
                        <button id="resultsBtn" class="btn-secondary">View Results</button>
                        
                        <div class="footer">
                            <p class="footer-text">Powered by No Boring Shops</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function QuizScreen() {
            const question = questions[currentQuestion];
            const awardEmoji = question.award.match(/[\u{1F300}-\u{1F9FF}]/u)?.[0] || '‚ú®';
            
            return `
                <div class="container">
                    <div class="card card-wide">
                        <div class="quiz-header">
                            <div class="quiz-progress">
                                <span class="quiz-label">Question ${currentQuestion + 1} of ${questions.length}</span>
                                <span class="quiz-player">${playerName}</span>
                            </div>
                            <div style="display: flex; justify-content: center; gap: 8px; margin: 16px 0;">
                                ${questions.map((q, idx) => `
                                    <div style="width: 8px; height: 8px; border-radius: 50%; background: ${idx < currentQuestion ? '#10b981' : idx === currentQuestion ? '#111827' : '#e5e7eb'};"></div>
                                `).join('')}
                            </div>
                            <div class="progress-bar-bg">
                                <div class="progress-bar-fill" style="width: ${((currentQuestion + 1) / questions.length) * 100}%; background: linear-gradient(90deg, #111827 0%, #374151 100%)"></div>
                            </div>
                        </div>
                        
                        <div class="question-card" style="background: ${question.gradient}">
                            <div style="font-size: 48px; margin-bottom: 16px;">${awardEmoji}</div>
                            <p class="question-text">${question.question}</p>
                        </div>
                        
                        <div class="options-grid">
                            ${teamMembers.map(member => `
                                <button onclick="handleVote('${member}')" class="option-btn">
                                    <div style="font-size: 32px; margin-bottom: 8px;">${profilePics[member]}</div>
                                    ${member}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function ResultsScreen() {
            setTimeout(() => {
                launchCelebrationConfetti();
                playSound('trumpet');
            }, 300);
            
            const results = calculateResults();
            const sortedResults = Object.entries(results).sort(([, a], [, b]) => b.totalVotes - a.totalVotes);
            const votedCount = Object.keys(hasVoted).filter(k => k.indexOf('_endTime') === -1).length;
            const totalMembers = teamMembers.length;
            const allBadges = calculateBadges();
            
            return `
                <div class="results-container">
                    <div class="results-header">
                        <div class="trophy-icon">üèÜ</div>
                        <h1 class="results-title">The Results Are In</h1>
                        <p class="results-subtitle">Everyone's a winner! Here are your team superlatives</p>
                        <div class="vote-count-box">
                            <p class="vote-count-text">${votedCount} of ${totalMembers} team members have voted</p>
                        </div>
                    </div>
                    
                    ${sortedResults.length >= 3 ? `
                    <div class="podium-container" style="text-align: center; margin-bottom: 32px;">
                        <div class="podium-wrapper" style="display: inline-flex; align-items: flex-end; gap: 16px;">
                            <div class="podium-item" style="text-align: center;">
                                <div style="font-size: 48px; margin-bottom: 8px;">${profilePics[sortedResults[1][0]]}</div>
                                <div style="font-size: 32px;">ü•à</div>
                                <p style="font-weight: 700; color: #111827; margin-top: 8px;">${sortedResults[1][0]}</p>
                            </div>
                            <div class="podium-item podium-winner" style="text-align: center; transform: scale(1.2);">
                                <div style="font-size: 64px; margin-bottom: 8px;">${profilePics[sortedResults[0][0]]}</div>
                                <div style="font-size: 48px;">ü•á</div>
                                <p style="font-weight: 700; color: #111827; margin-top: 8px;">${sortedResults[0][0]}</p>
                            </div>
                            <div class="podium-item" style="text-align: center;">
                                <div style="font-size: 48px; margin-bottom: 8px;">${profilePics[sortedResults[2][0]]}</div>
                                <div style="font-size: 32px;">ü•â</div>
                                <p style="font-weight: 700; color: #111827; margin-top: 8px;">${sortedResults[2][0]}</p>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                    
                    <div class="results-list">
                        ${sortedResults.map(([person, data], index) => {
                            const personBadges = allBadges[person] || [];
                            const rankDisplay = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `#${index + 1}`;
                            
                            return `
                            <div class="result-card">
                                <div class="result-content">
                                    <div class="result-left">
                                        <div class="rank-badge" style="background: ${data.awards[0].gradient}">
                                            <span class="rank-number">${rankDisplay}</span>
                                        </div>
                                        <div style="font-size: 48px; margin-right: 16px;">${profilePics[person]}</div>
                                        <div class="result-info">
                                            <h3>${person} ${data.awards.length > 1 ? '‚≠ê' : ''}</h3>
                                            ${data.awards.map(award => {
                                                const question = questions.find(q => q.id === award.questionId);
                                                const categoryEmoji = question.category === 'fun' ? 'üòÑ' : question.category === 'skills' ? 'üí™' : '‚ú®';
                                                return `<p>${award.award} <span style="font-size: 0.8em; color: #9ca3af;">${categoryEmoji}</span></p>`;
                                            }).join('')}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `}).join('')}
                    </div>
                    
                    <div class="action-buttons">
                        <button onclick="viewStatistics()" class="btn-secondary">View Statistics üìä</button>
                        <button onclick="voteAgain()" class="btn-primary">Vote Again</button>
                        <button onclick="promptResetPassword()" class="btn-danger">Reset All Votes</button>
                        
                        <div class="footer">
                            <p class="footer-text">Powered by No Boring Shops</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function WaitingScreen() {
            const votedCount = Object.keys(hasVoted).filter(k => k.indexOf('_endTime') === -1).length;
            const totalMembers = teamMembers.length;
            const minRequired = 5;
            const allVoted = votedCount >= minRequired;
            const peopleWhoVoted = Object.keys(hasVoted).filter(k => k.indexOf('_endTime') === -1);
            const peopleWaiting = teamMembers.filter(member => !hasVoted[member]);
            
            if (allVoted) {
                setTimeout(() => launchConfetti(), 500);
            }
            
            return `
                <div class="container">
                    <div class="card">
                        <div class="logo-container">
                            <div class="logo">
                                <div class="logo-box">
                                    <span class="logo-text">NBS</span>
                                </div>
                                <div class="logo-dot"></div>
                            </div>
                            <h1>${allVoted ? 'üéâ Ready to View Results!' : '‚úì Thanks for Voting!'}</h1>
                            <p class="subtitle">${allVoted ? 'Enough votes collected to see results' : 'Waiting for others to complete the quiz'}</p>
                        </div>

                        <div class="progress-box">
                            <div class="progress-header">
                                <span class="progress-label">Team Progress</span>
                                <span class="progress-count">${votedCount}/${totalMembers} (minimum ${minRequired})</span>
                            </div>
                            <div class="progress-bar-bg">
                                <div class="progress-bar-fill" style="width: ${Math.min((votedCount / minRequired) * 100, 100)}%"></div>
                            </div>
                            <p class="progress-text">
                                ${allVoted 
                                    ? `üéâ ${votedCount} team members have voted! Click below to see the results.` 
                                    : `Need ${minRequired - votedCount} more vote${minRequired - votedCount !== 1 ? 's' : ''}. ${peopleWaiting.length > 0 ? `Waiting for: ${peopleWaiting.join(', ')}` : ''}`
                                }
                            </p>
                        </div>

                        ${allVoted ? `
                            <button onclick="viewResults()" class="btn-primary">View Results</button>
                        ` : `
                            <button onclick="refreshProgress()" class="btn-secondary">Refresh Progress</button>
                        `}
                        
                        <div class="footer">
                            <p class="footer-text">Powered by No Boring Shops</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function render() {
            const app = document.getElementById('app');

            if (loading) {
                app.innerHTML = `
                    <div class="container">
                        <div class="card">
                            <div class="loading">
                                <div class="spinner"></div>
                                <p style="color: #6b7280; font-weight: 500;">Loading...</p>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }

            if (currentScreen === 'welcome') {
                app.innerHTML = WelcomeScreen();
                
                const select = document.getElementById('playerSelect');
                const startBtn = document.getElementById('startBtn');
                const resultsBtn = document.getElementById('resultsBtn');
                
                if (playerName) {
                    select.value = playerName;
                    startBtn.disabled = false;
                }
                
                select.addEventListener('change', (e) => {
                    playerName = e.target.value;
                    startBtn.disabled = !playerName;
                    
                    const noticeContainer = e.target.parentElement;
                    const existingNotice = noticeContainer.querySelector('.voted-notice');
                    if (existingNotice) {
                        existingNotice.remove();
                    }
                    
                    if (playerName && hasVoted[playerName]) {
                        const notice = document.createElement('p');
                        notice.className = 'voted-notice';
                        notice.textContent = "‚úì You've already voted! You can vote again to update your answers.";
                        noticeContainer.appendChild(notice);
                    }
                });
                
                startBtn.addEventListener('click', () => {
                    currentScreen = 'quiz';
                    currentQuestion = 0;
                    render();
                });
                
                resultsBtn.addEventListener('click', async () => {
                    loading = true;
                    render();
                    await loadData();
                    
                    const votedCount = Object.keys(hasVoted).filter(k => k.indexOf('_endTime') === -1).length;
                    const minRequired = 5;
                    if (votedCount >= minRequired) {
                        currentScreen = 'results';
                    } else {
                        currentScreen = 'waiting';
                    }
                    render();
                });
            } else if (currentScreen === 'quiz') {
                app.innerHTML = QuizScreen();
            } else if (currentScreen === 'waiting') {
                app.innerHTML = WaitingScreen();
            } else if (currentScreen === 'results') {
                app.innerHTML = ResultsScreen();
            } else if (currentScreen === 'statistics') {
                app.innerHTML = StatisticsScreen();
            }
        }

        async function refreshProgress() {
            loading = true;
            render();
            await loadData();
        }

        function viewResults() {
            currentScreen = 'results';
            render();
        }

        function viewStatistics() {
            currentScreen = 'statistics';
            render();
        }

        function backToResults() {
            currentScreen = 'results';
            render();
        }

        function voteAgain() {
            currentScreen = 'welcome';
            playerName = '';
            currentQuestion = 0;
            render();
        }

        window.handleVote = handleVote;
        window.voteAgain = voteAgain;
        window.promptResetPassword = promptResetPassword;
        window.refreshProgress = refreshProgress;
        window.viewResults = viewResults;
        window.viewStatistics = viewStatistics;
        window.backToResults = backToResults;

        // Initialize app
        loadData();
    </script>
</body>
</html>
